<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИНМТ 8: Заговор Обджектов</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            background-image: url('https://i.imgur.com/8QJZQ4a.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            transition: background-image 1s ease;
        }

        .game-container {
            background-color: rgba(42, 42, 74, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            padding: 30px;
            max-width: 900px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 2px solid #4a4a8a;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #story-text {
            font-size: 1.2em;
            line-height: 1.7;
            margin-bottom: 30px;
            text-align: left;
            white-space: pre-wrap;
            min-height: 200px;
            padding: 15px;
            background-color: rgba(30, 30, 60, 0.5);
            border-radius: 8px;
            border-left: 4px solid #a0a0ff;
            animation: textAppear 0.5s ease;
        }

        @keyframes textAppear {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-button {
            background-color: #4a4a8a;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 15px 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .option-button:hover {
            background-color: #6a6ab0;
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        .option-button:active {
            background-color: #3a3a6a;
            transform: translateY(1px);
        }

        .option-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }

        .option-button:hover::after {
            left: 100%;
        }

        h1 {
            color: #a0a0ff;
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(160, 160, 255, 0.5);
            font-size: 2.2em;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px #a0a0ff; }
            to { text-shadow: 0 0 15px #a0a0ff, 0 0 20px #6a6ab0; }
        }

        strong {
            color: #ffcc00;
            font-weight: bold;
        }

        .character-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            border: 3px solid #a0a0ff;
            box-shadow: 0 0 10px rgba(160, 160, 255, 0.5);
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background-color: #ff5555;
            width: 100%;
            transition: width 0.5s ease;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        .item {
            background-color: #3a3a6a;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .sound-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(42, 42, 74, 0.8);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
        }

        .typewriter {
            border-right: 3px solid #a0a0ff;
            animation: blink 0.75s step-end infinite;
        }

        @keyframes blink {
            from, to { border-color: transparent }
            50% { border-color: #a0a0ff }
        }

        .scene-change {
            animation: sceneChange 1s ease;
        }

        @keyframes sceneChange {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        .hidden {
            display: none;
        }

        .ending-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            animation: fadeIn 1s ease;
        }

        .ending-title {
            font-size: 3em;
            margin-bottom: 20px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .ending-text {
            font-size: 1.5em;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .restart-button {
            padding: 15px 30px;
            background-color: #4a4a8a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-button:hover {
            background-color: #6a6ab0;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="game-container" id="game-container">
        <h1>ИНМТ 8: Заговор Обджектов</h1>
        <div id="character-display"></div>
        <div id="health-display" class="hidden">
            <div class="health-bar">
                <div class="health-fill" id="health-fill"></div>
            </div>
        </div>
        <div id="inventory-display" class="inventory hidden"></div>
        <div id="story-text" class="typewriter"></div>
        <div id="options-container" class="options-container"></div>
    </div>

    <div id="ending-screen" class="ending-screen">
        <h2 class="ending-title" id="ending-title"></h2>
        <div class="ending-text" id="ending-text"></div>
        <button class="restart-button" id="restart-button">Начать заново</button>
    </div>

    <div class="sound-control" onclick="toggleSound()">
        <img src="https://i.imgur.com/3YKFZQp.png" width="30" height="30" alt="Sound">
    </div>

    <audio id="background-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-668.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Игровые переменные
        let gameState = {
            health: 100,
            inventory: [],
            relationships: {},
            flags: {},
            currentScene: "start"
        };

        // Персонажи и их изображения (используем доступные изображения)
        const characters = {
            "Кнайф": "https://i.imgur.com/knife.png",
            "Брялок": "https://i.imgur.com/cat.png",
            "Хренайф": "https://i.imgur.com/knife2.png",
            "Бутылыч": "https://i.imgur.com/bottle.png",
            "Чарджери": "https://i.imgur.com/charger.png",
            "Сока": "https://i.imgur.com/juice.png",
            "Стёрка": "https://i.imgur.com/eraser.png",
            "Краткий": "https://i.imgur.com/short.png",
            "Й": "https://i.imgur.com/letter-y.png",
            "Ёшка": "https://i.imgur.com/josh.png",
            "Замазыч": "https://i.imgur.com/corrector.png",
            "Чашечка": "https://i.imgur.com/cup.png",
            "Нансенсу": "https://i.imgur.com/nonsense.png",
            "Пшика": "https://i.imgur.com/cat2.png",
            "Чёрно-белая": "https://i.imgur.com/bw.png"
        };

        // Звуковые эффекты
        const sounds = {
            click: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
            success: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'),
            failure: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3'),
            underwater: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-underwater-bubbles-1183.mp3'),
            battle: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-sword-clash-2780.mp3')
        };

        // Включение/выключение звука
        let soundEnabled = true;
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const music = document.getElementById('background-music');
            if (soundEnabled) {
                music.play();
            } else {
                music.pause();
            }
        }

        // Воспроизведение звукового эффекта
        function playSound(soundName) {
            if (!soundEnabled) return;
            const sound = sounds[soundName];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Sound error:", e));
            }
        }

        // История игры
        const story = {
            start: {
                text: `
Ты — **Кнайф**. Твоя голова гудит. Медленно открыв глаза, ты осознаёшь, что прикован к деревянной доске в кромешной темноте. Дерево холодное, верёвки врезаются в запястья. Паника нарастает.

**Кнайф**: (Кричит) "Э-Э-ЭЙ! Выпустите меня!"

Из темноты медленно выплывает силуэт. Это **Хренайф**. В его руке блестит предмет, до боли напоминающий... тебя самого.

**Хренайф**: "Ну здравствуй, хлопчик."

Ты бьёшься в оковах, моля о пощаде. Но Хренайф неумолим. Острый конец того, что так похоже на нож, резко втыкается тебе в ручку.
                `,
                options: [
                    { text: "Попытаться вырваться", next: "start_escape", action: function() { 
                        gameState.flags.triedEscape = true;
                        playSound('click');
                    }},
                    { text: "Притвориться мёртвым", next: "start_play_dead", action: function() {
                        gameState.flags.playedDead = true;
                        playSound('click');
                    }},
                    { text: "Продолжить...", next: "awakening" }
                ],
                onEnter: function() {
                    showCharacter("Кнайф");
                    updateHealth(100);
                    playSound('click');
                }
            },
            
            start_escape: {
                text: `
Ты изо всех сил пытаешься вырваться, но верёвки только сильнее впиваются в запястья. 

**Хренайф**: (Смеётся) "Ну и упрямый же ты! Мне это нравится."

Он подносит свой клинок ближе к твоему лезвию, и ты чувствуешь странное покалывание. Вдруг перед глазами вспыхивают яркие искры, и сознание ускользает...
                `,
                options: [
                    { text: "Продолжить...", next: "awakening" }
                ],
                onEnter: function() {
                    updateHealth(90);
                    playSound('failure');
                }
            },
            
            start_play_dead: {
                text: `
Ты замираешь, притворяясь мёртвым. Хренайф наклоняется ближе, изучая тебя.

**Хренайф**: "Хм... Слабоват оказался."

Он отворачивается, и в этот момент ты чувствуешь резкий удар по голове. Последнее, что ты видишь — его ухмылку перед тем, как провалиться в темноту...
                `,
                options: [
                    { text: "Продолжить...", next: "awakening" }
                ],
                onEnter: function() {
                    updateHealth(80);
                    playSound('failure');
                }
            },
            
            awakening: {
                text: `
Ты резко распахиваешь глаза. Рядом сидит **Брялок**, сосредоточенно что-то записывая. Вы сидите за столом.

**Брялок**: "Кнайф, не ори. У нас серьёзный разговор."

**Кнайф**: (Бурчит) "Кто бы говорил, ёмаё."

Брялок сдвигает брови, что-то помечая в своём дневнике. Ты замечаешь фразу: "Тем не менее он тот ещё тварёныш", рядом с более старой записью про Лампчку.

Тем временем, **Бутылыч** спрашивает у **Чарджери** и **Соки**: "Где вы были? Я вас по всей округе ищу."

**Чарджери**: "Мы на болото ходили, кое-что проверить."

Ты видишь короткий флешбэк: **Сока** безуспешно пытается открыть заросший железный люк с ручкой в виде буквы "Й". Это теплица из И.Н.М.Т. 4!

**Чарджери**: "Это наше дело, Бутылыч. Тебе не стоит влезать."

Внезапно в комнату врывается **Стёрка**.

**Стёрка**: "Всем сюда! Собрание. Краткий в 'отключенном режиме'."
                `,
                options: [
                    { text: "Присоединиться к собранию", next: "conspiracy" },
                    { text: "Спросить Брялка о своём состоянии", next: "ask_bryalok" },
                    { text: "Осмотреть помещение", next: "look_around" }
                ],
                onEnter: function() {
                    showCharacter("Брялок");
                    playSound('click');
                }
            },
            
            ask_bryalok: {
                text: `
Ты поворачиваешься к Брялоку:

**Кнайф**: "Эй, а что со мной было? Почему я тут?"

**Брялок**: (Не отрываясь от записей) "Тебя нашли без сознания у Чёрного озера. Хренайф, видимо, решил 'поиграть'. Не переживай, с тобой такое уже случалось."

Она наконец поднимает взгляд и добавляет:

**Брялок**: "Но сейчас не время для этого. Нам нужно на собрание. Краткий снова что-то задумал."
                `,
                options: [
                    { text: "Присоединиться к собранию", next: "conspiracy" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            look_around: {
                text: `
Ты оглядываешь помещение. Это похоже на старую лабораторию из ИНМТ 4. Стены покрыты странными символами, а на столе разложены чертежи каких-то механизмов.

В углу ты замечаешь знакомый силуэт — это **Чёрно-белая**, которая внимательно изучает один из чертежей. Она замечает твой взгляд и быстро скрывает бумагу.

**Чёрно-белая**: "Не твоё дело, Кнайф. Иди уже на собрание."
                `,
                options: [
                    { text: "Присоединиться к собранию", next: "conspiracy" },
                    { text: "Попытаться разглядеть чертёж", next: "look_blueprint", action: function() {
                        gameState.flags.sawBlueprint = true;
                    }}
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            look_blueprint: {
                text: `
Ты пытаешься подойти ближе, но Чёрно-белая резко разворачивается и закрывает чертёж.

**Чёрно-белая**: "Я сказала, не твоё дело! Это может спасти нас всех от Краткого, если ты не испортишь всё своим любопытством."

Она уходит, унося чертёж с собой. Похоже, тебе всё же придётся идти на собрание.
                `,
                options: [
                    { text: "Присоединиться к собранию", next: "conspiracy" }
                ],
                onEnter: function() {
                    playSound('failure');
                }
            },
            
            conspiracy: {
                text: `
## Заговор против Краткого

Вы собираетесь. Разговор идёт о чрезмерной жестокости **Краткого**.

**Чарджери**: "Он позволил сделать монстра из бедной Соки!"

**Бутылыч**: "И постоянно мешает нам в испытаниях!"

**Брялок**: "Ага, сплошное безобразие!"

**Кнайф**: "А вдруг малиновый заразил Лампчку?"

**Чёрно-белая**, выслушав всех, предлагает поставить Краткому ультиматум. **Замазыч** сомневается.

Выбор очевиден. Вы решаете больше не подчиняться воле властного симболара. Вашим новым ведущим станет **Ёшка** – он намного мягче и понятливее.

Осталось одно: договориться с **Чашечкой**, которая не хочет иметь дел с "Бандой".

Внезапно появляется **Краткий**.

**Краткий**: "О чём это вы хотите договориться с Чашечкой?"

**Й** (появляется рядом с Кратким): "Мы закончили анонсировать ребуты, а обджектов не нашли."

Краткий резко убивает Бутылыча за невыполненное поручение.

**Краткий**: "Раз вы не хотите по-хорошему, то придётся добиться соглашения магическими методами."

Краткий хватает стол и трижды ударяет им по всем вам. Всё вокруг меркнет...
                `,
                options: [
                    { text: "Продолжить...", next: "new_challenge" }
                ],
                onEnter: function() {
                    showCharacter("Краткий");
                    playSound('battle');
                }
            },
            
            new_challenge: {
                text: `
## Новое испытание

Ты приходишь в себя. Ты снова живой! Вокруг знакомые лица. **Краткий** объявляет испытание.

**Краткий**: "Как вы знаете, Ёшка заменял меня один эпизод. Что ж, ассистенту пора уходить."

**Ёшка** наигранно прощается с испытуемыми. **Й**, чуть менее наигранно, просит его проверить, не забыл ли тот что-то из личных вещей.

**Стёрка**: (Шепчет Замазычу) "Мы упускаем свой шанс!"

**Замазыч**: (Шепчет в ответ) "Чашечка не проинформирована, без неё мы не начнём."

Ёшка открывает свой чемодан на колёсиках, проверяя содержимое.

Хосты продолжают свою "дохлую актёрскую игру": оказывается, что волшебная палочка Ёшки "потерялась", а без неё он не сможет вернуться в Алфавит.

**Стёрка**: "Вот она! Прямо возле Краткого!"

Но Краткий в мгновение ока хватает палочку и выбрасывает её в Толщедузный Океан!

**Краткий**: "Испытание команд: поиск и возвращение волшебной палочки хозяину!"
                `,
                options: [
                    { text: "Принять вызов", next: "find_stick_start" },
                    { text: "Попытаться протестовать", next: "protest_challenge" },
                    { text: "Тайком переглянуться с Чёрно-белой", next: "look_at_chernobelaya" }
                ],
                onEnter: function() {
                    showCharacter("Ёшка");
                    playSound('click');
                }
            },
            
            protest_challenge: {
                text: `
Ты решаешь открыто выступить против:

**Кнайф**: "Это нечестно! Ты сам выбросил палочку!"

Краткий медленно поворачивается к тебе, его глаза сужаются.

**Краткий**: "Ох, Кнайф... Ты всегда такой... резкий."

Он делает резкое движение рукой, и ты чувствуешь, как твоё лезвие начинает нагреваться.

**Кнайф**: "А-А-А! Горячо!"

**Краткий**: "Вот видишь, даже ты не можешь быть острым всё время. Принимай вызов или раздели участь Бутылыча."
                `,
                options: [
                    { text: "Сдаться и принять вызов", next: "find_stick_start" },
                    { text: "Продолжать сопротивляться", next: "continue_protest" }
                ],
                onEnter: function() {
                    updateHealth(70);
                    playSound('failure');
                }
            },
            
            continue_protest: {
                text: `
Несмотря на боль, ты продолжаешь:

**Кнайф**: "Нет! Мы не будем участвовать в твоих жестоких играх!"

Краткий вздыхает и делает ещё более резкий жест. Боль становится невыносимой, и ты теряешь сознание.

Когда ты приходишь в себя, остальные уже готовятся к испытанию. Похоже, тебе придётся присоединиться.
                `,
                options: [
                    { text: "Присоединиться к поиску палочки", next: "find_stick_start" }
                ],
                onEnter: function() {
                    updateHealth(50);
                    playSound('failure');
                }
            },
            
            look_at_chernobelaya: {
                text: `
Ты украдкой переглядываешься с Чёрно-белой. Она едва заметно кивает и что-то шепчет под нос. 

Внезапно ты чувствуешь странное облегчение — боль от ожога Краткого утихает. 

**Чёрно-белая**: (Шёпотом) "Не сейчас. Позже."

Похоже, у неё есть какой-то план, но сейчас тебе всё же придётся участвовать в испытании.
                `,
                options: [
                    { text: "Принять вызов", next: "find_stick_start" }
                ],
                onEnter: function() {
                    gameState.flags.chernobelayaHelp = true;
                    updateHealth(90);
                    playSound('success');
                }
            },
            
            find_stick_start: {
                text: `
## Поиск Палочки

Сразу после объявления испытания **Стёрка** пытается заговорить с **Чашечкой**, но та просто уходит. Без её убеждения, ваш план не сработает.

**Нансенсу** летит вслед за подругой, чтобы её утешить.

**Стёрка**: (Обращается к Брялку) "Брялок, поговори с Чашечкой! Она не хочет с нами общаться."

**Брялок**: "Нет. Несмотря на то, что мы против Краткого, я до сих пор соперник 'Банды'."

Брялок уходит, ведя за собой "Цветущий Май".

"Цветущий Май" подходит к берегу океана.

**Кнайф**: "Будем нырять по считалочке?"

**Брялок**: (С досадой) "Сейчас не время для шуток, Кнайф! Нужен план. На дно океана не проникают солнечные лучи."

Брялок просит у Бутылыча холст с карандашом и начинает рассказывать свой план.

**Брялок**: "Для успешной экспедиции нам понадобится трос, водоупорный контейнер, источник света и средство связи."

**Кнайф**: "Ты когда-нибудь перестанешь нести бред?"

Брялок (сердитая кошка) грубо затыкает Кнайфа.

**Брялок**: "Несколько обджектов останутся на берегу, чтобы тянуть трос, привязанный к ёмкости, в которой будут сидеть я и остальные. Опустившись на дно, мы будем освещать его, пока не найдём палочку. Затем один из нас вылезет из контейнера, схватит палочку и вернётся обратно. После этого мы сообщим оставшимся на берегу, что всё готово, и они вытянут нас обратно."

**Бутылыч**: "План получился крайне громоздким. Ты заняла весь холст, мне теперь не на чём рисовать."
                `,
                options: [
                    { text: "Попробовать уговорить Чашечку", next: "persuade_chashechka" },
                    { text: "Отправиться к океану, чтобы начать спуск", next: "prepare_expedition" },
                    { text: "Предложить альтернативный план", next: "alternative_plan" }
                ],
                onEnter: function() {
                    showCharacter("Брялок");
                    playSound('click');
                }
            },
            
            alternative_plan: {
                text: `
Ты решаешь предложить альтернативный план:

**Кнайф**: "А почему бы не использовать способности Чарджери? Она же может заряжать вещи. Может, она сможет как-то притянуть палочку?"

Все задумываются. **Чарджери** выглядит заинтересованной.

**Чарджери**: "Я могу попробовать... Но мне нужно что-то металлическое, что проводит энергию."

**Сока**: "У меня есть стальной канат! Он металлический!"

**Брялок**: (Задумчиво) "Это... на самом деле неплохая идея. Мы могли бы привязать к канату что-то, что притянет палочку, а Чарджери зарядит это."

План начинает обретать форму. Возможно, вам даже не придётся погружаться на дно.
                `,
                options: [
                    { text: "Попробовать этот план", next: "try_chargeri_plan" },
                    { text: "Всё же использовать оригинальный план Брялка", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    gameState.flags.alternativePlan = true;
                    playSound('click');
                }
            },
            
            try_chargeri_plan: {
                text: `
Вы решаете попробовать план с **Чарджери**. **Сока** приносит стальной канат, а **Бутылыч** находит небольшой металлический крюк.

**Чарджери**: "Хорошо, я попробую зарядить этот крюк, чтобы он притягивал волшебную энергию. Палочка Ёшки должна быть ею пропитана."

Она концентрируется, и её руки начинают светиться. Энергия перетекает в крюк, который начинает слабо мерцать.

**Чарджери**: "Готово! Теперь опустите крюк в воду. Если палочка где-то рядом, он должен притянуться к ней."

Вы опускаете канат в воду и ждёте. Проходит несколько напряжённых минут...

Внезапно канат дёргается!

**Сока**: "Что-то есть! Я чувствую!"

Она начинает тянуть канат обратно. Все затаили дыхание...
                `,
                options: [
                    { text: "Помочь Соке тянуть канат", next: "help_soka_pull" },
                    { text: "Подготовиться к возможной опасности", next: "prepare_for_danger" }
                ],
                onEnter: function() {
                    showCharacter("Чарджери");
                    playSound('click');
                }
            },
            
            help_soka_pull: {
                text: `
Ты бросаешься помогать **Соке** тянуть канат. Вместе вы быстро вытягиваете его на поверхность.

К вашему разочарованию, на конце каната оказывается не палочка, а старый, покрытый водорослями... **Й**!

**Й**: (Кашляя) "Что за чёрт?! Я только хотел проверить, что вы тут делаете!"

Оказывается, он следил за вами по приказу Краткого. Ваш план провалился, а теперь Й знает о вашей попытке обойти испытание.

**Й**: "Краткому это не понравится... Вам лучше побыстрее найти эту палочку."
                `,
                options: [
                    { text: "Вернуться к оригинальному плану Брялка", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    playSound('failure');
                }
            },
            
            prepare_for_danger: {
                text: `
Вместо того чтобы сразу тянуть канат, ты предупреждающе поднимаешь руку:

**Кнайф**: "Стоп! Давайте будем осторожны. Мы не знаем, что там."

**Брялок** кивает и берёт в руки фонарь. **Замазыч** готовится к возможной атаке.

**Сока** медленно начинает тянуть канат. Внезапно раздаётся громкий всплеск, и из воды вылетает... **Пшика**!

Она прицепилась к крюку и теперь летит прямо на вас!

**Пшика**: "Мяяяяяяяяяу!"
                `,
                options: [
                    { text: "Попытаться увернуться", next: "dodge_pshika" },
                    { text: "Принять удар на себя", next: "take_pshika_hit" }
                ],
                onEnter: function() {
                    showCharacter("Пшика");
                    playSound('battle');
                }
            },
            
            dodge_pshika: {
                text: `
Ты пытаешься увернуться, но **Пшика** меняет траекторию в воздухе и всё равно врезается в тебя. Вы оба падаете на песок.

**Пшика**: "Мяу! Ты думал, что сможешь избежать меня? Краткий прислал меня следить за вами!"

Она царапает тебя, прежде чем **Брялок** и **Чарджери** оттаскивают её.

**Пшика**: "Вы всё равно не найдёте палочку такими методами! Мяяяу!"

С этими словами она убегает. Ваш план провалился, и теперь Краткий знает о вашей попытке обойти испытание.
                `,
                options: [
                    { text: "Вернуться к оригинальному плану Брялка", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    updateHealth(80);
                    playSound('failure');
                }
            },
            
            take_pshika_hit: {
                text: `
Ты решаешь принять удар на себя, чтобы защитить других. **Пшика** врезается в тебя с размаху, и вы оба падаете.

**Пшика**: "Мяу! Зачем ты это сделал?!"

**Кнайф**: "Потому что мы команда. И мы найдём эту палочку, несмотря ни на что."

Пшика смотрит на тебя странным взглядом, затем спрыгивает.

**Пшика**: "Мяу... Может быть, вы и правда достойны её найти. Но Краткий всё равно не позволит вам победить."

Она убегает, оставив вас с провалившимся планом.
                `,
                options: [
                    { text: "Вернуться к оригинальному плану Брялка", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    updateHealth(75);
                    playSound('failure');
                    gameState.flags.pshikaRespect = true;
                }
            },
            
            persuade_chashechka: {
                text: `
Вы решили попытаться убедить **Чашечку** присоединиться к вам. Без неё ваш план против Краткого может провалиться.

Вы находите Чашечку неподалёку, она всё ещё выглядит отстранённой. Рядом с ней находится **Нансенсу**, пытающаяся её утешить.

**Стёрка**: "Чашечка, пожалуйста, послушай нас! Мы хотим покончить с тиранией Краткого. Нам нужна твоя помощь."

**Чашечка**: (Холодно) "Я уже сказала, я не имею никаких связей с 'Бандой'. Вы сами по себе, я сама по себе."

**Нансенсу**: "Чашечка, но ведь это ради всех нас! Краткий становится всё более невыносимым!"

**Чашечка**: "Моё мнение не изменится. Я не хочу втягиваться в ваши разборки."

Ты (**Кнайф**) понимаешь, что прямое давление не сработает. Чашечка упряма.
                `,
                options: [
                    { text: "Попытаться предложить Чашечке что-то взамен за её помощь.", next: "offer_chashechka" },
                    { text: "Оставить попытки и сосредоточиться на поиске палочки.", next: "prepare_expedition" },
                    { text: "Попросить Нансенсу попытаться убедить Чашечку.", next: "ask_nansensu" },
                    { text: "Рассказать о плане Чёрно-белой", next: "tell_about_chernobelaya_plan", condition: function() { return gameState.flags.sawBlueprint; } }
                ],
                onEnter: function() {
                    showCharacter("Чашечка");
                    playSound('click');
                }
            },
            
            tell_about_chernobelaya_plan: {
                text: `
Ты решаешь рассказать о том, что видел:

**Кнайф**: "Чашечка, Чёрно-белая что-то задумала. У неё есть чертёж какого-то устройства. Она сказала, что это может спасти нас от Краткого."

Чашечка наконец-то проявляет интерес:

**Чашечка**: "Чёрно-белая? Она всегда была умнее, чем казалась... Что именно ты видел?"

Ты описываешь чертёж, насколько можешь вспомнить. Чашечка задумывается.

**Чашечка**: "Если это правда... Тогда, возможно, у нас есть шанс. Но мне нужно поговорить с Чёрно-белой лично."

Она поворачивается к Нансенсу:

**Чашечка**: "Пойдём. Нам нужно найти её."

Похоже, ты заинтересовал Чашечку, но теперь она хочет действовать самостоятельно.
                `,
                options: [
                    { text: "Вернуться к поиску палочки", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    gameState.flags.chashechkaInterested = true;
                    playSound('success');
                }
            },
            
            offer_chashechka: {
                text: `
Вы решаете попробовать предложить **Чашечке** что-то взамен за её помощь. Возможно, это изменит её позицию.

**Кнайф**: "Чашечка, послушай. Мы понимаем, что ты не хочешь ввязываться. Но что, если мы сможем что-то предложить тебе? Какая у тебя цель? Что мы можем сделать для тебя, если ты нам поможешь?"

Чашечка смотрит на вас, слегка нахмурившись. Видно, что она обдумывает ваши слова.

**Чашечка**: "Моя цель... это спокойствие и независимость. Я не хочу, чтобы Краткий или кто-либо ещё диктовал мне, что делать. Если вы сможете обеспечить это для меня, тогда, возможно, я рассмотрю ваше предложение."

**Нансенсу** ободряюще кивает Чашечке.
                `,
                options: [
                    { text: "Мы обещаем, что с Ёшкой у тебя будет полная свобода и никто не будет тебя принуждать.", next: "chashechka_role" },
                    { text: "Хорошо, если ты поможешь нам сейчас, мы гарантируем твою независимость после того, как Краткий будет свергнут.", next: "chashechka_role" },
                    { text: "А как насчёт конкретных условий? Что именно ты хочешь?", next: "chashechka_conditions" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            chashechka_conditions: {
                text: `
Вы решаете уточнить конкретные условия, чтобы понять, что именно **Чашечка** хочет.

**Кнайф**: "Хорошо, Чашечка, мы готовы пойти тебе навстречу. А как насчёт конкретных условий? Что именно ты хочешь, чтобы мы могли гарантировать твою независимость?"

Чашечка немного задумывается.

**Чашечка**: "Я хочу быть уверена, что никто не будет заставлять меня участвовать в испытаниях против моей воли. И чтобы мои идеи и моё мнение уважались, а не игнорировались, как это часто бывает. Мне нужна **гарантия невмешательства** в мою личную жизнь и решения."

**Нансенсу** смотрит на вас, слегка приподняв бровь, словно намекая, что это разумные требования.
                `,
                options: [
                    { text: "Мы можем это гарантировать. С Ёшкой такого точно не будет.", next: "chashechka_role" },
                    { text: "Это справедливые требования. Мы обещаем обеспечить тебе полную свободу, если ты присоединишься к нам.", next: "chashechka_role" },
                    { text: "Мы согласны с твоими условиями. Какова будет твоя роль в нашем плане?", next: "chashechka_role" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            chashechka_role: {
                text: `
Вы соглашаетесь с условиями Чашечки и сразу переходите к следующему шагу – уточнению её роли.

**Кнайф**: "Мы согласны с твоими условиями, Чашечка. Гарантируем невмешательство в твою личную жизнь и решения, полную свободу. Какова будет твоя роль в нашем плане?"

Чашечка кивает, её взгляд становится чуть мягче.

**Чашечка**: "Хорошо. Если вы готовы выполнить эти условия, я помогу. Моя роль будет заключаться в том, чтобы **вести переговоры с обджектами, которые сомневаются или не хотят присоединяться к 'Банде'**. Я смогу их убедить, используя свой авторитет и то, что я не являюсь частью вашей группы. Я также могу быть **связующим звеном** между вами и теми, кто пока ещё не доверяет вашим планам."

**Нансенсу** улыбается, явно довольная решением Чашечки.

Теперь, когда Чашечка на вашей стороне, вы чувствуете прилив уверенности. Ваш план по свержению Краткого становится более реальным.
                `,
                options: [
                    { text: "Отправиться к океану, чтобы начать спуск.", next: "prepare_expedition" },
                    { text: "Обсудить детали дальнейших действий с Чашечкой и Нансенсу.", next: "discuss_details_chashechka" }
                ],
                onEnter: function() {
                    playSound('success');
                }
            },
            
            discuss_details_chashechka: {
                text: `
Вы решаете обсудить детали дальнейших действий с **Чашечкой** и **Нансенсу**.

**Кнайф**: "Отлично, Чашечка. Твоя помощь бесценна. Нам нужно будет скоординировать наши действия. Мы собираемся спуститься в океан за палочкой Ёшки. Пока мы там, можешь начать переговоры с другими обджектами? Чем больше нас будет, тем лучше."

**Чашечка**: "Хорошо. Я начну, как только вы отправитесь. А когда вы вернётесь, мы сможем собраться все вместе и выдвинуть ультиматум Краткиму."

**Нансенсу**: "Я помогу Чашечке. Вместе мы сможем убедить многих."

Всё выглядит очень хорошо. У вас есть поддержка Чашечки, и вы готовы к следующему этапу.
                `,
                options: [
                    { text: "Отправиться к океану, чтобы начать спуск.", next: "prepare_expedition" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            ask_nansensu: {
                text: `
Вы решаете попросить **Нансенсу** попытаться убедить **Чашечку**, так как они подруги.

**Кнайф**: "Нансенсу, ты её подруга. Может, ты сможешь донести до неё, насколько это важно для всех нас?"

**Нансенсу**: (Вздыхает) "Я уже пыталась, но Чашечка очень упряма. Но я попробую ещё раз."

Нансенсу отходит в сторону с Чашечкой, тихо что-то ей объясняя. Видно, что Чашечка колеблется.
                `,
                options: [
                    { text: "Подождать их разговора", next: "wait_nansensu" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            wait_nansensu: {
                text: `
Вы ждёте, пока **Нансенсу** и **Чашечка** закончат свой разговор. Наконец, Чашечка поворачивается к вам.

**Чашечка**: "Хорошо. Я согласна. Но у меня есть условия."
                `,
                options: [
                    { text: "Выслушать условия Чашечки", next: "chashechka_conditions" }
                ],
                onEnter: function() {
                    playSound('success');
                }
            },
            
            prepare_expedition: {
                text: `
## Подготовка к экспедиции

Отличные новости! Теперь, когда **Чашечка** на вашей стороне и вы заручились её поддержкой, пришло время действовать. У вас есть все необходимые приспособления для погружения: **стальной канат** от Соки, **суперрастяжимый чепчик Брялка** в качестве контейнера, **фёнарик** для освещения и **йодио** для связи, полученные от Ёшки.

**Брялок** уже ждёт у берега Толщедузного Океана вместе с остальными из "Цветущего Мая". План экспедиции к палочке Ёшки чёткий, хоть и громоздкий, как подметил Бутылыч.

Вы подходите к берегу. Впереди бескрайние тёмные воды океана.
                `,
                options: [
                    { text: "Начать подготовку к спуску: привязать чепчик, распределить роли.", next: "prepare_descent" },
                    { text: "Провести финальный инструктаж по использованию фёнарика и йодио.", next: "final_briefing" }
                ],
                onEnter: function() {
                    showCharacter("Брялок");
                    playSound('click');
                }
            },
            
            final_briefing: {
                text: `
Вы решаете провести финальный инструктаж по использованию **фёнарика** и **йодио**, чтобы убедиться, что все всё поняли.

Вы достаёте **фёнарик**. "С ним всё просто," говорите вы, "нажимаем кнопку, и он загорается. На дне будет темно, так что свет крайне важен. Не направляйте его прямо в глаза друг другу."

Затем вы берёте **йодио**. "Ёшка настроил его на '202-й поток'. Чтобы связаться с берегом, просто говорите в него. Главное, запомните его предупреждение: **не нажимайте другие цифры**. Мы не хотим случайно связаться с чем-то... потусторонним."

Все кивают, подтверждая, что поняли инструкции. Оборудование проверено, и команда готова к погружению.
                `,
                options: [
                    { text: "Начать подготовку к спуску: привязать чепчик, распределить роли.", next: "prepare_descent" },
                    { text: "Сделать глубокий вдох и приказать начать спуск.", next: "descent_start" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            prepare_descent: {
                text: `
Вы решаете начать финальную подготовку к спуску.

**Брялок** берёт свой **суперрастяжимый чепчик** и вместе с **Бутылычем** начинает аккуратно раскрывать его, готовя к погружению. **Сока** разматывает **стальной канат**, который ей дал Ёшка, и готовится его держать.

**Брялок**: "Так, на берегу остаются **Сока** (чтобы держать канат), **Бутылыч** (чтобы следить за связью и помогать с вытягиванием) и, возможно, кто-то ещё по желанию. Вниз со мной пойдут **Кнайф** (ты, конечно же), **Чарджери** и **Замазыч**. Нам нужно по четыре глаза на глубине, чтобы точно найти палочку."

**Кнайф**: "Звучит разумно. А что насчёт света? Кто будет держать фёнарик?"

**Брялок**: "Я возьму фёнарик. Он достаточно компактный, и я смогу его контролировать. Замазыч, ты будешь отвечать за йодио. Сообщай нам, если что-то пойдёт не так или если мы что-то найдём."

Все соглашаются с распределением ролей. Чепчик готов к погружению, канат натянут, и внутри уже занимают места те, кто отправится на дно океана. На берегу остаются Сока, Бутылыч и Стёрка, готовые тянуть трос.
                `,
                options: [
                    { text: "Отдать команду к началу спуска.", next: "descent_start" },
                    { text: "Задать последний уточняющий вопрос по плану.", next: "last_question" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            last_question: {
                text: `
Вы решаете задать последний уточняющий вопрос по плану.

**Кнайф**: "Брялок, а что насчёт времени? Сколько примерно мы сможем пробыть под водой в этом чепчике? И что, если мы не найдём палочку сразу?"

**Брялок**: "Хороший вопрос, Кнайф. Чепчик хоть и растяжимый, но не бесконечный. Думаю, у нас есть минут 15-20, прежде чем воздух станет совсем тяжёлым. Если не найдём сразу, мы поднимемся, чтобы перегруппироваться, и попробуем снова. Главное — сохранять спокойствие и чётко следовать плану. Связь с берегом должна работать, так что мы будем держать вас в курсе."

Все кивают. План кажется хоть и рискованным, но тщательно продуманным. Все готовы к погружению.
                `,
                options: [
                    { text: "Отдать команду к началу спуска.", next: "descent_start" },
                    { text: "Попросить Стёрку напомнить Чашечке о договорённостях, чтобы та начала убеждать сомневающихся.", next: "remind_chashechka" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            remind_chashechka: {
                text: `
Вы просите **Стёрку** напомнить **Чашечке** о договорённостях, чтобы та начала убеждать сомневающихся обджектов.

**Стёрка**: "Чашечка, помнишь о наших условиях? Мы сейчас начинаем спуск, а ты приступай к своей части плана."

**Чашечка**: "Помню. Я уже начинаю. Удачи вам там."

Теперь вы точно уверены, что всё идёт по плану, как на глубине, так и на поверхности.
                `,
                options: [
                    { text: "Отдать команду к началу спуска.", next: "descent_start" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            descent_start: {
                text: `
Пришло время действовать.

**Брялок** подаёт знак, и **Сока**, **Бутылыч** и **Стёрка** на берегу начинают медленно опускать **чепчик** на канате в тёмные воды Толщедузного Океана. Внутри тесного, но надёжного контейнера, ты, **Кнайф**, вместе с **Чарджери** и **Замазычем**, чувствуешь, как вас начинает тянуть вниз.

Вода обступает вас со всех сторон, погружая во всё более глубокую темноту. Вы слышите лишь приглушённые звуки снаружи, пока чепчик медленно опускается в неизвестность.

**Брялок** включает **фёнарик**, и луч света пронзает мрак, освещая небольшой участок вокруг вас. Вы смотрите вниз, пытаясь разглядеть что-то в непроницаемой синеве.
                `,
                options: [
                    { text: "Начать внимательно осматриваться в поисках палочки.", next: "search_stick" },
                    { text: "Запросить связь с берегом по йодио, чтобы убедиться, что всё в порядке.", next: "check_radio" }
                ],
                onEnter: function() {
                    playSound('underwater');
                }
            },
            
            check_radio: {
                text: `
Оказавшись под водой, первым делом вы решаете проверить связь.

**Замазыч** берёт **йодио** и включает его. Немного шипения, а затем:

**Замазыч**: "Берег, приём, приём. Как слышно? Мы на глубине, всё в порядке."

Через несколько секунд раздаётся голос **Бутылыча**, немного приглушённый, но чёткий:

**Бутылыч**: "Слышу отлично! У нас тоже всё хорошо. Канат держим крепко. Начинайте поиск!"

Получив подтверждение, что связь работает, вы переходите к главному.

**Брялок** направляет луч **фёнарика** вперёд, медленно вращая им из стороны в сторону. Вокруг вас — плотная, почти осязаемая тьма, которую прорезает лишь этот одинокий луч. Дно океана кажется бесконечным и полным теней.

**Кнайф**: "Разделяемся по секторам? Или просто плывём вперёд?"

**Чарджери**: "Лучше по секторам. Так мы ничего не упустим. Я осматриваю левую сторону, Замазыч — правую, а вы, Брялок и Кнайф, фокусируйтесь на том, что прямо перед нами."

Вы начинаете внимательно осматривать дно, выискивая что-то, напоминающее волшебную палочку Ёшки. Время идёт, и воздух в чепчике становится ощутимо тяжелее. Каждая секунда на счету.
                `,
                options: [
                    { text: "Внезапно фёнарик начинает мерцать.", next: "flashlight_flicker" },
                    { text: "Вы замечаете что-то блестящее вдалеке.", next: "find_something" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            search_stick: {
                text: `
**Брялок** направляет луч **фёнарика** вперёд, медленно вращая им из стороны в сторону. Вокруг вас — плотная, почти осязаемая тьма, которую прорезает лишь этот одинокий луч. Дно океана кажется бесконечным и полным теней.

**Кнайф**: "Разделяемся по секторам? Или просто плывём вперёд?"

**Чарджери**: "Лучше по секторам. Так мы ничего не упустим. Я осматриваю левую сторону, Замазыч — правую, а вы, Брялок и Кнайф, фокусируйтесь на том, что прямо перед нами."

Вы начинаете внимательно осматривать дно, выискивая что-то, напоминающее волшебную палочку Ёшки. Время идёт, и воздух в чепчике становится ощутимо тяжелее. Каждая секунда на счету.
                `,
                options: [
                    { text: "Внезапно фёнарик начинает мерцать.", next: "flashlight_flicker" },
                    { text: "Вы замечаете что-то блестящее вдалеке.", next: "find_something" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            flashlight_flicker: {
                text: `
Внезапно **фёнарик начинает мерцать**, а затем и вовсе гаснет, погружая вас в кромешную тьму. Единственный источник света исчез! Внутри чепчика становится душно, а ощущение замкнутого пространства усиливается.

**Брялок**: "Чёрт! Фонарик сел!"

**Чарджери**: "Что теперь? Мы ничего не видим!"

Паника начинает нарастать. Вы находитесь на дне океана, в полной темноте, и воздух постепенно заканчивается.
                `,
                options: [
                    { text: "Попробовать потрясти фёнарик, чтобы он снова заработал.", next: "shake_flashlight" },
                    { text: "Сказать Замазычу связаться с берегом и попросить вытягивать вас.", next: "call_for_help" },
                    { text: "Попытаться нащупать палочку вслепую, пока не закончился воздух.", next: "search_blind" }
                ],
                onEnter: function() {
                    playSound('failure');
                }
            },
            
            shake_flashlight: {
                text: `
Вы пытаетесь потрясти **фёнарик**, но он остаётся мёртвым. Батарея окончательно села. Теперь вы точно в полной темноте.
                `,
                options: [
                    { text: "Сказать Замазычу связаться с берегом и попросить вытягивать вас.", next: "call_for_help" },
                    { text: "Попытаться нащупать палочку вслепую, пока не закончился воздух.", next: "search_blind" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            call_for_help: {
                text: `
**Замазыч** берёт **йодио** и пытается связаться с берегом.

**Замазыч**: "Берег! Фонарик погас! Мы в темноте! Воздух кончается! Тяните нас!"

Голос **Бутылыча** в ответ: "Понял! Начинаем вытягивать! Держитесь!"

Вы чувствуете, как чепчик начинает медленно, но верно подниматься. Каждая секунда кажется вечностью.
                `,
                options: [
                    { text: "Продолжить подниматься...", next: "ending_failure" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            search_blind: {
                text: `
В полной темноте, когда каждая секунда на счету, вы решаете рискнуть и попытаться нащупать палочку вслепую. Воздуха становится всё меньше, и времени на раздумья нет.

**Кнайф**: "Нужно действовать! Фонарик погас, но палочка должна быть где-то здесь! Давайте попробуем нащупать её!"

Вы, **Кнайф**, вытягиваете руки в кромешную темноту внутри чепчика, осторожно двигая ими по дну. **Чарджери** и **Замазыч** следуют вашему примеру, стараясь не задеть друг друга в тесном пространстве. Каждый миллиметр важен. Вы чувствуете холодное, скользкое дно, но ничего похожего на деревянную палочку.

Воздух в чепчике становится *очень* тяжёлым. Вы начинаете чувствовать головокружение.
                `,
                options: [
                    { text: "Вы или кто-то другой нащупываете что-то твёрдое и гладкое!", next: "find_stick_blind_success" },
                    { text: "Замазыч начинает паниковать, и вы слышите его прерывистое дыхание.", next: "panic_blind" },
                    { text: "Связь с берегом внезапно обрывается.", next: "radio_disconnect_blind" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            find_stick_blind_success: {
                text: `
В кромешной темноте, когда ваши лёгкие уже горели от нехватки воздуха, внезапно раздался возглас **Брялка**!

**Брялок**: "Есть! Я что-то нащупала! Оно твёрдое и гладкое!"

Ты чувствуешь, как чепчик слегка колыхнулся, когда **Брялок** потянулась к находке. Напряжение висит в воздухе. Смогла ли она найти палочку Ёшки?
                `,
                options: [
                    { text: "Сперва нападает Пшика, а Брялок бежит отдавать палочку", next: "pshika_attack" }
                ],
                onEnter: function() {
                    playSound('success');
                }
            },
            
            pshika_attack: {
                text: `
Как только **Брялок** воскликнула, что нащупала что-то, внезапно вас атакует **Пшика**! Она появляется словно из ниоткуда в кромешной темноте, и вы чувствуете, как её клейкие лапы пытаются схватить вас!

Ты, **Кнайф**, реагируешь мгновенно. Несмотря на нехватку воздуха и темноту, ты бросаешься вперёд, чтобы задержать Пшику, принимая удар на себя.

**Кнайф**: "Беги, Брялок! Я задержу её! Отдай палочку!"

**Брялок** не медлит. Она чувствует, как ты сражаешься с Пшикой, и, держа найденный предмет в руках, изо всех сил бросается прочь, стараясь как можно быстрее выбраться из чепчика и доставить палочку наверх.

Ты слышишь, как она выбирается из контейнера, и чувствуешь, как чепчик начинает медленно подниматься. Твоя задача — продержаться как можно дольше, пока Брялок не отдаст палочку Ёшке. Пшика сильна, и её атаки ощутимы даже в этой кромешной темноте.
                `,
                options: [
                    { text: "Пытаться нанести ей ответный удар, чтобы оттолкнуть.", next: "fight_pshika" },
                    { text: "Цепляться за неё, стараясь максимально обездвижить, пока Брялок не уйдёт далеко.", next: "hold_pshika" },
                    { text: "Кричать Замазычу, чтобы тот использовал йодио и вызвал помощь с берега.", next: "call_help_pshika" }
                ],
                onEnter: function() {
                    playSound('battle');
                }
            },
            
            fight_pshika: {
                text: `
Ты пытаешься нанести **Пшике** ответный удар, но в темноте и тесноте это крайне сложно. Её клейкие лапы обвиваются вокруг тебя, ещё крепче сжимая. Ты слышишь, как она злорадно шипит.
                `,
                options: [
                    { text: "Продолжить цепляться за неё, чтобы выиграть время.", next: "hold_pshika" },
                    { text: "Потерять сознание.", next: "lose_consciousness_pshika" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            hold_pshika: {
                text: `
В этой кромешной темноте и нехватке воздуха, ты принимаешь стратегическое решение: **цепляешься за Пшику, стараясь максимально обездвижить её**, пока **Брялок** не уйдёт далеко с палочкой.

Ты обхватываешь Пшику, чувствуя её скользкую, липкую поверхность. Она пытается вырваться, но ты вцепляешься в неё изо всех сил, используя весь свой вес и силу. Пшика бьётся, её конечности хлещут воздух вокруг вас, но ты не отпускаешь. Ты слышишь приглушенные звуки борьбы и чувствуешь, как чепчик медленно поднимается. Каждый момент важен.

Ты ощущаешь, как силы покидают тебя. Воздух почти на исходе, и твоё тело начинает сдаваться. Но мысль о победе над Кратким и о том, что Брялок несёт палочку, даёт тебе силы держаться.
                `,
                options: [
                    { text: "Ты слышишь крик Брялка, означающий, что она выбралась и передала палочку!", next: "success_delivery" },
                    { text: "Пшика внезапно ослабляет хватку и отступает.", next: "pshika_retreats" },
                    { text: "Ты теряешь сознание от нехватки воздуха.", next: "lose_consciousness_pshika" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            call_help_pshika: {
                text: `
Ты кричишь **Замазычу**, чтобы тот использовал **йодио** и вызвал помощь с берега.

**Кнайф**: "Замазыч! Связь! Пшика! Тяните нас! Быстрее!"

**Замазыч** пытается что-то сказать в рацию, но голос Бутылыча звучит очень слабо и прерывисто. Кажется, связь прерывается из-за помех или глубины.
                `,
                options: [
                    { text: "Пытаться продержаться самому, пока не вытянут.", next: "hold_pshika" },
                    { text: "Потерять сознание.", next: "lose_consciousness_pshika" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            pshika_retreats: {
                text: `
Пшика внезапно ослабляет хватку и отступает. Она, похоже, теряет интерес, осознав, что цель достигнута, и палочка больше не в чепчике.
                `,
                options: [
                    { text: "Ты слышишь крик Брялка, означающий, что она выбралась и передала палочку!", next: "success_delivery" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            lose_consciousness_pshika: {
                text: `
Ты чувствуешь, как последние капли воздуха покидают твои лёгкие. Пшика всё ещё держит тебя, но её хватка кажется слабее. Внезапно всё вокруг начинает расплываться, и ты теряешь сознание...

Когда ты приходишь в себя, ты уже на берегу. **Брялок** стоит рядом и смотрит на тебя с облегчением.

**Брялок**: "Ты сделал это! Я успела передать палочку Ёшке! Пшика отпустила тебя, как только поняла, что палочки больше нет в чепчике."

Ты видишь, как **Ёшка** держит свою палочку и улыбается. Краткий выглядит раздражённым, но ничего не может поделать.
                `,
                options: [
                    { text: "Продолжить...", next: "success_delivery" }
                ],
                onEnter: function() {
                    updateHealth(30);
                    playSound('success');
                }
            },
            
            panic_blind: {
                text: `
**Замазыч** начинает паниковать, его дыхание становится прерывистым и частым. В темноте ты слышишь, как он бьётся о стенки чепчика.

**Замазыч**: "Мы не выберемся! Мы все умрём здесь!"

Ты пытаешься его успокоить, но это только усиливает его панику. Внезапно он хватает йодио и начинает беспорядочно нажимать все кнопки!

**Брялок**: "Нет! Останови его! Ёшка предупреждал!"

Но уже поздно. Раздаётся странный звук, и чепчик начинает трястись. Вода вокруг вас внезапно становится ледяной, а затем... всё пропадает.

Когда ты приходишь в себя, ты один в каком-то странном, пустом пространстве. Никого больше нет. Ты кричишь, но никто не отвечает. Похоже, ты навсегда застрял в этом пустом месте между мирами...
                `,
                options: [],
                onEnter: function() {
                    showEnding("Ужасный конец", "Вы навсегда застряли в пустом пространстве между мирами после того, как Замазыч активировал запрещённые частоты на йодио.");
                    playSound('failure');
                }
            },
            
            radio_disconnect_blind: {
                text: `
Связь с берегом внезапно обрывается. Последнее, что ты слышишь — это крик **Бутылыча**, а затем только тишину.

**Брялок**: "Что-то случилось на берегу! Нам нужно выбираться самим!"

Но без связи и света у вас нет шансов. Вы пытаетесь найти выход, но в полной темноте это невозможно. Воздух заканчивается, и ты чувствуешь, как сознание начинает покидать тебя...

Когда ты приходишь в себя, ты один на берегу. Вокруг никого нет — ни друзей, ни врагов. Только бесконечный океан и пустой пляж. Ты кричишь, но никто не отвечает. Похоже, ты остался один в этом мире навсегда...
                `,
                options: [],
                onEnter: function() {
                    showEnding("Одинокий конец", "Вы остались совершенно один в пустом мире после неудачной экспедиции.");
                    playSound('failure');
                }
            },
            
            find_something: {
                text: `
Ты замечаешь слабое мерцание вдалеке. Это может быть палочка!

**Кнайф**: "Там! Видите? Что-то блестит!"

**Брялок** направляет фёнарик в указанном направлении, и вы видите — это действительно палочка Ёшки! Она лежит на небольшом выступе, частично засыпанная песком.

**Брялок**: "Нужно её достать! Кто-то должен выйти из чепчика."

Но прежде чем вы успеваете что-то предпринять, из темноты появляется **Пшика**! Она уже направляется к палочке!
                `,
                options: [
                    { text: "Быстро выйти из чепчика и схватить палочку первым", next: "grab_stick_fast" },
                    { text: "Попытаться отвлечь Пшику, пока Брялок достаёт палочку", next: "distract_pshika" }
                ],
                onEnter: function() {
                    showCharacter("Пшика");
                    playSound('battle');
                }
            },
            
            grab_stick_fast: {
                text: `
Ты быстро выбираешься из чепчика и бросаешься к палочке. Вода холодная и плотная, двигаться тяжело. Пшика уже близко!

Ты хватаешь палочку как раз в тот момент, когда Пшика бросается на тебя. Её когти впиваются в твою рукоятку, но ты уже передаёшь палочку **Брялок**, которая ждёт у чепчика.

**Брялок**: "Держись! Я передам её Ёшке!"

Она быстро скрывается внутри чепчика, а ты остаёшься один на один с разъярённой Пшикой. Она кружит вокруг тебя, готовая к атаке.
                `,
                options: [
                    { text: "Попытаться отвлечь её и дать Брялоку время", next: "final_distraction" },
                    { text: "Быстро попытаться вернуться в чепчик", next: "return_to_container" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            final_distraction: {
                text: `
Ты решаешь отвлечь **Пшику**, чтобы дать **Брялоку** время доставить палочку. Ты начинаешь двигаться в противоположную сторону от чепчика, привлекая её внимание.

**Пшика**: "Мяу! Ты думаешь, что сможешь меня обмануть?"

Она бросается за тобой, но ты уворачиваешься. Вода замедляет ваши движения, делая этот странный танец почти грациозным.

Внезапно ты чувствуешь, как чепчик начинает подниматься. Брялок сделала это! Теперь тебе нужно только самому выбраться.

Пшика, поняв, что её обманули, в ярости бросается на тебя в последней попытке нанести удар...
                `,
                options: [
                    { text: "Увернуться и попытаться всплыть", next: "dodge_and_rise" },
                    { text: "Принять удар, чтобы быстрее всплыть", next: "take_hit_and_rise" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            dodge_and_rise: {
                text: `
Ты пытаешься увернуться от **Пшики** и начать всплывать. Она промахивается, но её коготь всё равно задевает тебя, оставляя глубокую царапину.

Ты изо всех сил плывёшь вверх, чувствуя, как лёгкие горят от нехватки воздуха. Пшика пытается последовать за тобой, но внезапно останавливается, словно что-то её удерживает.

Ты вырываешься на поверхность и видишь, что **Брялок** уже передала палочку **Ёшке**. Он держит её в руках и улыбается.

**Ёшка**: "Спасибо, друзья! Теперь я могу вернуться домой... и взять кое-что с собой!"

Он делает пасс палочкой, и **Краткий** внезапно начинает уменьшаться в размерах! Вы победили!
                `,
                options: [
                    { text: "Продолжить...", next: "success_delivery" }
                ],
                onEnter: function() {
                    updateHealth(60);
                    playSound('success');
                }
            },
            
            take_hit_and_rise: {
                text: `
Ты решаешь принять удар, чтобы использовать его импульс для всплытия. **Пшика** врезается в тебя с размаху, и вы оба летите вверх.

Боль пронзает тебя, но ты продолжаешь двигаться к поверхности. Вода вокруг начинает светлеть, и вот ты уже вырываешься на воздух!

**Брялок** и другие уже на берегу. Ёшка держит свою палочку и улыбается. Краткий выглядит раздражённым, но ничего не может поделать.

Пшика выныривает рядом с тобой, но видит, что уже поздно. Она недовольно мяукает и уплывает.

Вы сделали это! Палочка возвращена, и Ёшка может теперь справиться с Кратким.
                `,
                options: [
                    { text: "Продолжить...", next: "success_delivery" }
                ],
                onEnter: function() {
                    updateHealth(40);
                    playSound('success');
                }
            },
            
            return_to_container: {
                text: `
Ты пытаешься быстро вернуться к чепчику, но **Пшика** оказывается быстрее. Она преграждает тебе путь, её глаза сверкают в темноте.

**Пшика**: "Мяу! Ты никуда не денешься!"

Ты понимаешь, что не сможешь пройти мимо неё. Но в этот момент чепчик начинает подниматься — **Брялок** уже внутри и передала палочку!

Пшика, услышав это, мгновенно теряет интерес к тебе и бросается к поверхности, пытаясь ещё что-то сделать. Ты медленно всплываешь, чувствуя, как силы покидают тебя.

Когда ты оказываешься на берегу, ты видишь, как **Ёшка** держит свою палочку и улыбается. Краткий выглядит раздражённым, но ничего не может поделать. Вы победили!
                `,
                options: [
                    { text: "Продолжить...", next: "success_delivery" }
                ],
                onEnter: function() {
                    updateHealth(50);
                    playSound('success');
                }
            },
            
            distract_pshika: {
                text: `
Ты решаешь отвлечь **Пшику**, пока **Брялок** попытается достать палочку. Ты начинаешь махать руками и кричать:

**Кнайф**: "Эй, Пшика! Посмотри сюда! Я тут вкусненький!"

Пшика на мгновение отвлекается на тебя, и этого достаточно, чтобы Брялок выскользнула из чепчика и направилась к палочке.

Но Пшика быстро понимает твой трюк и бросается к Брялоку! Теперь всё зависит от того, кто окажется быстрее...
                `,
                options: [
                    { text: "Попытаться перехватить Пшику", next: "intercept_pshika" },
                    { text: "Довериться скорости Брялка", next: "trust_bryalok" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            intercept_pshika: {
                text: `
Ты бросаешься наперерез **Пшике**, пытаясь перехватить её. Вы сталкиваетесь в воде, и это замедляет её достаточно, чтобы **Брялок** успела схватить палочку!

**Брялок**: "Есть! Я её достала!"

Она быстро возвращается к чепчику, а ты остаёшься один на один с разъярённой Пшикой. Она кружит вокруг тебя, готовая к атаке.
                `,
                options: [
                    { text: "Попытаться отвлечь её и дать Брялоку время", next: "final_distraction" },
                    { text: "Быстро попытаться вернуться в чепчик", next: "return_to_container" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            },
            
            trust_bryalok: {
                text: `
Ты решаешь довериться скорости **Брялка** и не вмешиваться. **Пшика** мчится к ней, но Брялок оказывается проворнее! Она хватает палочку как раз перед тем, как Пшика достигает её, и быстро возвращается в чепчик.

Пшика в ярости бросается к чепчику, но он уже начинает подниматься. Она поворачивается к тебе — теперь ты единственная цель для её гнева.
                `,
                options: [
                    { text: "Попытаться отвлечь её и дать Брялоку время", next: "final_distraction" },
                    { text: "Быстро попытаться вернуться в чепчик", next: "return_to_container" }
                ],
                onEnter: function() {
                    playSound('click');
                }
            }
        };

        // Функции для работы с игрой
        function loadScene(sceneId) {
            const scene = story[sceneId];
            if (!scene) return;
            
            gameState.currentScene = sceneId;
            
            // Обновляем текст сцены с эффектом печатания
            const storyElement = document.getElementById('story-text');
            storyElement.classList.remove('typewriter');
            storyElement.textContent = '';
            
            // Запускаем анимацию печатания
            let i = 0;
            const text = scene.text;
            const speed = 20;
            
            function typeWriter() {
                if (i < text.length) {
                    storyElement.innerHTML = text.substring(0, i+1);
                    i++;
                    setTimeout(typeWriter, speed);
                } else {
                    storyElement.classList.add('typewriter');
                }
            }
            
            typeWriter();
            
            // Очищаем предыдущие варианты
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            // Добавляем новые варианты
            if (scene.options && scene.options.length > 0) {
                scene.options.forEach(option => {
                    // Проверяем условие, если оно есть
                    if (option.condition && !option.condition()) return;
                    
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option.text;
                    button.onclick = function() {
                        playSound('click');
                        if (option.action) option.action();
                        loadScene(option.next);
                    };
                    optionsContainer.appendChild(button);
                });
            }
            
            // Вызываем специальную функцию при входе в сцену
            if (scene.onEnter) scene.onEnter();
            
            // Обновляем инвентарь
            updateInventoryDisplay();
        }

        function showCharacter(characterName) {
            const characterDisplay = document.getElementById('character-display');
            if (characters[characterName]) {
                characterDisplay.innerHTML = `<img src="${characters[characterName]}" alt="${characterName}" class="character-image"><p>${characterName}</p>`;
            } else {
                characterDisplay.innerHTML = '';
            }
        }

        function updateHealth(value) {
            gameState.health = value;
            const healthFill = document.getElementById('health-fill');
            const healthDisplay = document.getElementById('health-display');
            
            if (value < 100) {
                healthDisplay.classList.remove('hidden');
                healthFill.style.width = `${value}%`;
                
                if (value < 30) {
                    healthFill.style.backgroundColor = '#ff0000';
                } else if (value < 60) {
                    healthFill.style.backgroundColor = '#ff5555';
                } else {
                    healthFill.style.backgroundColor = '#55ff55';
                }
            } else {
                healthDisplay.classList.add('hidden');
            }
        }

        function updateInventoryDisplay() {
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            
            if (gameState.inventory.length > 0) {
                inventoryDisplay.classList.remove('hidden');
                gameState.inventory.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'item';
                    itemElement.textContent = item;
                    inventoryDisplay.appendChild(itemElement);
                });
            } else {
                inventoryDisplay.classList.add('hidden');
            }
        }

        function showEnding(title, text) {
            document.getElementById('ending-title').textContent = title;
            document.getElementById('ending-text').textContent = text;
            document.getElementById('ending-screen').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
        }

        function restartGame() {
            gameState = {
                health: 100,
                inventory: [],
                relationships: {},
                flags: {},
                currentScene: "start"
            };
            document.getElementById('ending-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            loadScene('start');
        }

        // Инициализация игры
        document.addEventListener('DOMContentLoaded', function() {
            // Назначение обработчика для кнопки рестарта
            document.getElementById('restart-button').addEventListener('click', restartGame);
            
            // Попытка запуска фоновой музыки (браузеры блокируют автовоспроизведение)
            document.addEventListener('click', function() {
                const music = document.getElementById('background-music');
                if (soundEnabled && music.paused) {
                    music.volume = 0.3;
                    music.play().catch(e => console.log("Music error:", e));
                }
            }, { once: true });
            
            // Начальная загрузка сцены
            loadScene('start');
        });
    </script>
</body>
</html>